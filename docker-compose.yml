version: '3.8'

networks:
    crm-network:
        driver: bridge

volumes:
    postgres-data:
        driver: local
    redis-data:
        driver: local
    rabbitmq-data:
        driver: local

services:
    # PHP-FPM + Laravel
    app:
        build:
            context: .
            dockerfile: docker/Dockerfile
            target: development
        container_name: crm_app
        restart: unless-stopped
        working_dir: /var/www
        volumes:
            - ./:/var/www
            - ./docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini
        networks:
            - crm-network
        environment:
            - APP_ENV=${APP_ENV:-local}
            - CONTAINER_ROLE=app
        depends_on:
            - postgres
            - redis
            - rabbitmq

    # Nginx Web Server
    nginx:
        image: nginx:alpine
        container_name: crm_nginx
        restart: unless-stopped
        ports:
            - "8080:80"
            - "443:443"
        volumes:
            - ./:/var/www
            - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
            - ./docker/nginx/conf.d:/etc/nginx/conf.d
            - ./docker/nginx/ssl:/etc/nginx/ssl
        networks:
            - crm-network
        depends_on:
            - app

    # PostgreSQL Database
    postgres:
        image: postgres:16-alpine
        container_name: crm_postgres
        restart: unless-stopped
        environment:
            POSTGRES_DB: ${DB_DATABASE:-crm_platform}
            POSTGRES_USER: ${DB_USERNAME:-crm_user}
            POSTGRES_PASSWORD: ${DB_PASSWORD:-secret}
            PGDATA: /var/lib/postgresql/data/pgdata
        volumes:
            - postgres-data:/var/lib/postgresql/data
            - ./docker/postgres/init:/docker-entrypoint-initdb.d
        ports:
            - "5432:5432"
        networks:
            - crm-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-crm_user}"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Redis (Cache, Queue, Session)
    redis:
        image: redis:7-alpine
        container_name: crm_redis
        restart: unless-stopped
        command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redispass}
        volumes:
            - redis-data:/data
        ports:
            - "6379:6379"
        networks:
            - crm-network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    # RabbitMQ (Message Queue)
    rabbitmq:
        image: rabbitmq:3-management-alpine
        container_name: crm_rabbitmq
        restart: unless-stopped
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-admin}
            RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-crm}
        volumes:
            - rabbitmq-data:/var/lib/rabbitmq
        ports:
            - "5672:5672"   # AMQP
            - "15672:15672" # Management UI
        networks:
            - crm-network
        healthcheck:
            test: ["CMD", "rabbitmq-diagnostics", "ping"]
            interval: 30s
            timeout: 10s
            retries: 5

    # Laravel Queue Worker
    queue:
        build:
            context: .
            dockerfile: docker/Dockerfile
            target: development
        container_name: crm_queue
        restart: unless-stopped
        working_dir: /var/www
        volumes:
            - ./:/var/www
        networks:
            - crm-network
        environment:
            - CONTAINER_ROLE=queue
        depends_on:
            - app
            - postgres
            - redis
            - rabbitmq
        command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600

    # Laravel Scheduler
    scheduler:
        build:
            context: .
            dockerfile: docker/Dockerfile
            target: development
        container_name: crm_scheduler
        restart: unless-stopped
        working_dir: /var/www
        volumes:
            - ./:/var/www
        networks:
            - crm-network
        environment:
            - CONTAINER_ROLE=scheduler
        depends_on:
            - app
        command: /bin/sh -c "while true; do php artisan schedule:run --verbose --no-interaction & sleep 60; done"

    # Mailhog (Development Email Testing)
    mailhog:
        image: mailhog/mailhog:latest
        container_name: crm_mailhog
        restart: unless-stopped
        ports:
            - "1025:1025" # SMTP
            - "8025:8025" # Web UI
        networks:
            - crm-network

    # Adminer (Database Management)
    adminer:
        image: adminer:latest
        container_name: crm_adminer
        restart: unless-stopped
        ports:
            - "8081:8080"
        networks:
            - crm-network
        environment:
            ADMINER_DEFAULT_SERVER: postgres
